name: CloudStream Derleyici

on:
  workflow_dispatch:
  push:
    branches: [ "main", "master" ]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # 1️⃣ Kaynak kodları çek
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          path: src
          fetch-depth: 0

      # 2️⃣ builds branch için klasör oluştur ve initialize et
      - name: Prepare builds branch
        run: |
          mkdir -p builds
          cd builds
          git init
          git remote add origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          git fetch origin builds || echo "builds branch yok, oluşturulacak"
          git checkout -B builds || git checkout -b builds

      # 3️⃣ JDK 17 kurulumu
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # 4️⃣ Gradle kurulumu
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      # 5️⃣ Gradlew çalıştırılabilir yap
      - name: Make gradlew executable
        run: chmod +x src/gradlew

      # 6️⃣ Eklentileri derle (.cs3 + plugins.json)
      - name: Build plugins
        working-directory: src
        run: ./gradlew clean createCs3 makePluginsJson --no-daemon

      # 7️⃣ Çıktıları builds klasörüne kopyala
      - name: Copy outputs
        run: |
          mkdir -p builds
          cp src/build/outputs/*.cs3 builds/ || true
          cp src/build/outputs/plugins.json builds/ || true

      # 8️⃣ Author tag değiştir
      - name: Replace author tag
        run: |
          if [ -f "builds/plugins.json" ]; then
            sed -i 's/@KekikAkademi/@UmayTrade/g' builds/plugins.json || true
          fi

      # 9️⃣ Commit ve push (exit code 1 engellendi)
      - name: Commit and push to builds branch
        run: |
          cd builds
          git config user.name "github-actions[bot]"
          git config user.email "actions@github.com"
          git add .
          git diff-index --quiet HEAD || git commit -m "Automatik derleme: $GITHUB_SHA"
          git push --force origin builds
